<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Thông Tin Thiết Bị</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f7f6; }
        h2 { color: #2e7d32; text-align: center; }
        .container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .form-group { display: flex; flex-direction: column; }
        label { font-weight: bold; font-size: 12px; margin-bottom: 5px; color: #333; }
        input, select, textarea { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .btn-group { text-align: center; margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px; }
        button { padding: 10px 20px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; transition: 0.3s; }
        .btn-add { background-color: #2ecc71; color: white; margin-right: 10px; }
        .btn-export { background-color: #3498db; color: white; }
        button:hover { opacity: 0.8; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 11px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #2e7d32; color: white; white-space: nowrap; }
        
        /* Hiệu ứng khi chọn hàng */
        tbody tr { cursor: pointer; transition: background 0.2s; }
        tbody tr:hover { background-color: #e8f5e9 ! resentment; }
        
        /* Màu sắc tuân thủ */
        .status-tuanthu { background-color: #2ecc71 !important; color: white; font-weight: bold; text-align: center; }
        .status-motphan { background-color: #f1c40f !important; color: black; font-weight: bold; text-align: center; }
        .status-khong { background-color: #e74c3c !important; color: white; font-weight: bold; text-align: center; }

        .hidden { display: none; }
        .remedial-section { 
            grid-column: 1 / -1; 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 15px; 
            background: #fff3e0; 
            padding: 15px; 
            border-radius: 5px;
            border-left: 5px solid #ff9800;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>NHẬP HỒ SƠ QUẢN LÝ THIẾT BỊ</h2>
    
    <div class="form-grid" id="mainForm">
        <div class="form-group">
            <label>Tên thiết bị</label>
            <input type="text" id="tenThietBi" placeholder="Ví dụ: lăng xích điện">
        </div>
        <div class="form-group">
            <label>Mã hồ sơ</label>
            <input type="text" id="maHoSo">
        </div>
        <div class="form-group">
            <label>Mã thiết bị</label>
            <input type="text" id="maThietBi">
        </div>
        <div class="form-group">
            <label>Số chế tạo</label>
            <input type="text" id="soCheTao">
        </div>
        <div class="form-group">
            <label>Khu vực sử dụng</label>
            <input type="text" id="khuVuc">
        </div>
        <div class="form-group">
            <label>CO</label>
            <select id="co"><option>Có</option><option>Chưa có</option></select>
        </div>
        <div class="form-group">
            <label>CQ</label>
            <select id="cq"><option>Có</option><option>Chưa có</option></select>
        </div>
        <div class="form-group">
            <label>Hợp quy</label>
            <select id="hopQuy"><option>Có</option><option>Chưa có</option></select>
        </div>
        <div class="form-group">
            <label>Thông tin chung (Xuất xứ, hãng...)</label>
            <textarea id="thongTinChung" rows="2"></textarea>
        </div>
        <div class="form-group">
            <label>Năm SX</label>
            <input type="number" id="namSX" value="2025">
        </div>
        <div class="form-group">
            <label>Ngày kiểm định gần nhất</label>
            <input type="date" id="ngayKiemDinh">
        </div>
        <div class="form-group">
            <label>Ngày kiểm định tiếp theo</label>
            <input type="date" id="ngayKiemDinhTiepTheo">
        </div>
        <div class="form-group">
            <label>Ngày khai báo</label>
            <input type="date" id="ngayKhaiBao">
        </div>
        <div class="form-group">
            <label>Tình trạng sử dụng</label>
            <select id="tinhTrang">
                <option value="Đang sử dụng">Đang sử dụng</option>
                <option value="Tạm ngừng sử dụng">Tạm ngừng sử dụng</option>
                <option value="Đã thanh lý">Đã thanh lý</option>
            </select>
        </div>
        <div class="form-group">
            <label>Người đánh giá</label>
            <input type="text" id="nguoiDanhGia">
        </div>
        <div class="form-group">
            <label>Tình trạng tuân thủ</label>
            <select id="tuanThu" onchange="toggleRemedial()">
                <option value="Tuân thủ">Tuân thủ</option>
                <option value="Tuân thủ 1 phần">Tuân thủ 1 phần</option>
                <option value="Không tuân thủ">Không tuân thủ</option>
            </select>
        </div>

        <div id="remedialFields" class="remedial-section hidden">
            <div class="form-group">
                <label>Hành động khắc phục</label>
                <input type="text" id="hanhDongKhacPhuc" placeholder="Nhập nội dung khắc phục">
            </div>
            <div class="form-group">
                <label>Người thực hiện</label>
                <input type="text" id="nguoiThucHien">
            </div>
            <div class="form-group">
                <label>Thời hạn hoàn thành</label>
                <input type="date" id="thoiHanHoanThanh">
            </div>
        </div>
    </div>

    <div class="btn-group">
        <button class="btn-add" onclick="addRow()">+ Thêm vào danh sách</button>
        <button class="btn-export" onclick="exportToExcel()">⬇ Xuất file Excel (.xlsx)</button>
    </div>

    <div style="overflow-x: auto;">
        <table id="dataTable">
            <thead>
                <tr>
                    <th>Ngày khai báo</th>
                    <th>Tên thiết bị</th>
                    <th>Mã hồ sơ</th>
                    <th>Mã thiết bị</th>
                    <th>Số chế tạo</th>
                    <th>Khu vực</th>
                    <th>CO</th>
                    <th>CQ</th>
                    <th>Hợp quy</th>
                    <th>Thông tin chung</th>
                    <th>Năm SX</th>
                    <th>Kiểm định gần nhất</th>
                    <th>Kiểm định tiếp theo</th>
                    <th>Tình trạng</th>
                    <th>Người ĐG</th>
                    <th>Đánh giá tuân thủ</th>
                    <th>Khắc phục</th>
                    <th>Người thực hiện</th>
                    <th>Thời hạn</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script>
    let dataStore = [];

    function toggleRemedial() {
        const value = document.getElementById('tuanThu').value;
        const remedialFields = document.getElementById('remedialFields');
        if (value === "Tuân thủ 1 phần" || value === "Không tuân thủ") {
            remedialFields.classList.remove('hidden');
        } else {
            remedialFields.classList.add('hidden');
        }
    }

    function addRow() {
        const entry = {
            ngayKhaiBao: document.getElementById('ngayKhaiBao').value,
            tenThietBi: document.getElementById('tenThietBi').value,
            maHoSo: document.getElementById('maHoSo').value,
            maThietBi: document.getElementById('maThietBi').value,
            soCheTao: document.getElementById('soCheTao').value,
            khuVuc: document.getElementById('khuVuc').value,
            co: document.getElementById('co').value,
            cq: document.getElementById('cq').value,
            hopQuy: document.getElementById('hopQuy').value,
            thongTinChung: document.getElementById('thongTinChung').value,
            namSX: document.getElementById('namSX').value,
            ngayKiemDinh: document.getElementById('ngayKiemDinh').value,
            ngayKiemDinhTiepTheo: document.getElementById('ngayKiemDinhTiepTheo').value,
            tinhTrang: document.getElementById('tinhTrang').value,
            nguoiDanhGia: document.getElementById('nguoiDanhGia').value,
            tuanThu: document.getElementById('tuanThu').value,
            hanhDongKhacPhuc: document.getElementById('hanhDongKhacPhuc').value || "-",
            nguoiThucHien: document.getElementById('nguoiThucHien').value || "-",
            thoiHan: document.getElementById('thoiHanHoanThanh').value || "-"
        };

        dataStore.push(entry);
        updateTable();
        
        // Chỉ reset những ô thông tin biến động, giữ lại thông tin chung nếu cần nhập tiếp
        document.getElementById('tenThietBi').value = '';
        document.getElementById('maThietBi').value = '';
        document.getElementById('soCheTao').value = '';
    }

    function updateTable() {
        const tbody = document.querySelector('#dataTable tbody');
        tbody.innerHTML = '';
        dataStore.forEach((item, index) => {
            // Xác định class màu sắc
            let statusClass = '';
            if (item.tuanThu === "Tuân thủ") statusClass = 'status-tuanthu';
            else if (item.tuanThu === "Tuân thủ 1 phần") statusClass = 'status-motphan';
            else if (item.tuanThu === "Không tuân thủ") statusClass = 'status-khong';

            const row = `<tr onclick="loadEntry(${index})">
                <td>${item.ngayKhaiBao}</td>
                <td>${item.tenThietBi}</td>
                <td>${item.maHoSo}</td>
                <td>${item.maThietBi}</td>
                <td>${item.soCheTao}</td>
                <td>${item.khuVuc}</td>
                <td>${item.co}</td>
                <td>${item.cq}</td>
                <td>${item.hopQuy}</td>
                <td>${item.thongTinChung}</td>
                <td>${item.namSX}</td>
                <td>${item.ngayKiemDinh}</td>
                <td>${item.ngayKiemDinhTiepTheo}</td>
                <td>${item.tinhTrang}</td>
                <td>${item.nguoiDanhGia}</td>
                <td class="${statusClass}">${item.tuanThu}</td>
                <td>${item.hanhDongKhacPhuc}</td>
                <td>${item.nguoiThucHien}</td>
                <td>${item.thoiHan}</td>
            </tr>`;
            tbody.innerHTML += row;
        });
    }

    // Hàm load dữ liệu ngược lên Form khi bấm vào dòng
    function loadEntry(index) {
        const item = dataStore[index];
        document.getElementById('ngayKhaiBao').value = item.ngayKhaiBao;
        document.getElementById('tenThietBi').value = item.tenThietBi;
        document.getElementById('maHoSo').value = item.maHoSo;
        document.getElementById('maThietBi').value = item.maThietBi;
        document.getElementById('soCheTao').value = item.soCheTao;
        document.getElementById('khuVuc').value = item.khuVuc;
        document.getElementById('co').value = item.co;
        document.getElementById('cq').value = item.cq;
        document.getElementById('hopQuy').value = item.hopQuy;
        document.getElementById('thongTinChung').value = item.thongTinChung;
        document.getElementById('namSX').value = item.namSX;
        document.getElementById('ngayKiemDinh').value = item.ngayKiemDinh;
        document.getElementById('ngayKiemDinhTiepTheo').value = item.ngayKiemDinhTiepTheo;
        document.getElementById('tinhTrang').value = item.tinhTrang;
        document.getElementById('nguoiDanhGia').value = item.nguoiDanhGia;
        document.getElementById('tuanThu').value = item.tuanThu;
        
        // Xử lý các ô khắc phục
        toggleRemedial();
        if (item.tuanThu !== "Tuân thủ") {
            document.getElementById('hanhDongKhacPhuc').value = item.hanhDongKhacPhuc === "-" ? "" : item.hanhDongKhacPhuc;
            document.getElementById('nguoiThucHien').value = item.nguoiThucHien === "-" ? "" : item.nguoiThucHien;
            document.getElementById('thoiHanHoanThanh').value = item.thoiHan === "-" ? "" : item.thoiHan;
        }

        // Thông báo nhẹ cho người dùng
        console.log("Đã tải thông tin thiết bị: " + item.tenThietBi);
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function exportToExcel() {
        if(dataStore.length === 0) {
            alert("Vui lòng nhập ít nhất một dòng dữ liệu!");
            return;
        }
        const worksheet = XLSX.utils.json_to_sheet(dataStore);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "ThongKeThietBi");
        XLSX.writeFile(workbook, "Thong_Ke_Thiet_Bi.xlsx");
    }
</script>

</body>
</html>
