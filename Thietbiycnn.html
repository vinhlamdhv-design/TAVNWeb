<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Thiết Bị - Cập Nhật Tuân Thủ</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; background-color: #e8f5e9; }
        h2 { color: #1b5e20; text-align: center; text-transform: uppercase; }
        .container { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-width: 1100px; margin: auto; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .form-group { display: flex; flex-direction: column; }
        label { font-weight: bold; font-size: 13px; margin-bottom: 5px; color: #2e7d32; }
        input, select, textarea { padding: 10px; border: 1px solid #bdc3c7; border-radius: 4px; font-size: 14px; }
        input:focus, select:focus { border-color: #2e7d32; outline: none; box-shadow: 0 0 5px rgba(46,125,50,0.3); }
        
        /* Phần ẩn hiện động */
        #remedySection { 
            grid-column: 1 / -1; 
            display: none; 
            background: #fff3e0; 
            padding: 15px; 
            border-radius: 8px; 
            border-left: 5px solid #ff9800;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .btn-group { text-align: center; margin-top: 25px; padding-top: 20px; border-top: 2px solid #eee; }
        button { padding: 12px 25px; cursor: pointer; border: none; border-radius: 6px; font-weight: bold; font-size: 14px; transition: 0.3s; }
        .btn-add { background-color: #27ae60; color: white; margin-right: 10px; }
        .btn-export { background-color: #2980b9; color: white; }
        button:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); opacity: 0.9; }
        
        .table-container { overflow-x: auto; margin-top: 30px; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; background: white; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #2e7d32; color: white; white-space: nowrap; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        .status-tag { padding: 3px 8px; border-radius: 10px; color: white; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h2>Hệ Thống Nhập Dữ Liệu Kiểm Tra Thiết Bị</h2>
    
    <div class="form-grid">
        <div class="form-group">
            <label>Tên thiết bị</label>
            <input type="text" id="tenThietBi" placeholder="VD: Bảng điện, Máy nén khí...">
        </div>
        <div class="form-group">
            <label>Mã số thiết bị</label>
            <input type="text" id="maSo">
        </div>
        <div class="form-group">
            <label>Khu vực sử dụng</label>
            <input type="text" id="khuVuc">
        </div>

        <div class="form-group">
            <label>Tình trạng tuân thủ</label>
            <select id="tinhTrangTuanThu" onchange="toggleRemedy()">
                <option value="Tuân thủ">Tuân thủ</option>
                <option value="Tuân thủ 1 phần">Tuân thủ 1 phần</option>
                <option value="Không tuân thủ">Không tuân thủ</option>
            </select>
        </div>

        <div class="form-group">
            <label>Năm sản xuất</label>
            <input type="number" id="namSX" value="2024">
        </div>
        <div class="form-group">
            <label>Người đánh giá</label>
            <input type="text" id="nguoiDanhGia">
        </div>

        <div id="remedySection">
            <div class="form-group">
                <label>Hành động khắc phục cần thực hiện</label>
                <textarea id="hanhDongKhacPhuc" rows="2" placeholder="Nhập các bước cần làm..."></textarea>
            </div>
            <div class="form-group">
                <label>Người thực hiện</label>
                <input type="text" id="nguoiThucHien" placeholder="Tên nhân viên phụ trách">
            </div>
            <div class="form-group">
                <label>Thời hạn hoàn thành dự kiến</label>
                <input type="date" id="thoiHan">
            </div>
        </div>
    </div>

    <div class="btn-group">
        <button class="btn-add" onclick="addRow()">+ Thêm Vào Danh Sách</button>
        <button class="btn-export" onclick="exportToExcel()">⬇ Xuất File Excel Thống Kê</button>
    </div>

    <div class="table-container">
        <table id="dataTable">
            <thead>
                <tr>
                    <th>Tên Thiết Bị</th>
                    <th>Mã Số</th>
                    <th>Khu Vực</th>
                    <th>Tình Trạng Tuân Thủ</th>
                    <th>Hành Động Khắc Phục</th>
                    <th>Người Thực Hiện</th>
                    <th>Thời Hạn</th>
                    <th>Người Đánh Giá</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script>
    let dataStore = [];

    // Hàm ẩn hiện phần khắc phục
    function toggleRemedy() {
        const status = document.getElementById('tinhTrangTuanThu').value;
        const remedySection = document.getElementById('remedySection');
        
        if (status === "Tuân thủ 1 phần" || status === "Không tuân thủ") {
            remedySection.style.display = 'grid';
        } else {
            remedySection.style.display = 'none';
            // Xóa dữ liệu cũ nếu người dùng đổi lại thành Tuân thủ
            document.getElementById('hanhDongKhacPhuc').value = '';
            document.getElementById('nguoiThucHien').value = '';
            document.getElementById('thoiHan').value = '';
        }
    }

    function addRow() {
        const entry = {
            "Tên Thiết Bị": document.getElementById('tenThietBi').value,
            "Mã Số": document.getElementById('maSo').value,
            "Khu Vực": document.getElementById('khuVuc').value,
            "Tình Trạng Tuân Thủ": document.getElementById('tinhTrangTuanThu').value,
            "Hành Động Khắc Phục": document.getElementById('hanhDongKhacPhuc').value || "-",
            "Người Thực Hiện": document.getElementById('nguoiThucHien').value || "-",
            "Thời Hạn": document.getElementById('thoiHan').value || "-",
            "Năm SX": document.getElementById('namSX').value,
            "Người Đánh Giá": document.getElementById('nguoiDanhGia').value
        };

        if(!entry["Tên Thiết Bị"]) {
            alert("Vui lòng nhập tên thiết bị!");
            return;
        }

        dataStore.push(entry);
        updateTable();
        resetForm();
    }

    function updateTable() {
        const tbody = document.querySelector('#dataTable tbody');
        tbody.innerHTML = '';
        dataStore.forEach(item => {
            const row = `<tr>
                <td>${item["Tên Thiết Bị"]}</td>
                <td>${item["Mã Số"]}</td>
                <td>${item["Khu Vực"]}</td>
                <td><b>${item["Tình Trạng Tuân Thủ"]}</b></td>
                <td>${item["Hành Động Khắc Phục"]}</td>
                <td>${item["Người Thực Hiện"]}</td>
                <td>${item["Thời Hạn"]}</td>
                <td>${item["Người Đánh Giá"]}</td>
            </tr>`;
            tbody.innerHTML += row;
        });
    }

    function resetForm() {
        document.getElementById('tenThietBi').value = '';
        document.getElementById('maSo').value = '';
        document.getElementById('hanhDongKhacPhuc').value = '';
        document.getElementById('nguoiThucHien').value = '';
        document.getElementById('thoiHan').value = '';
        document.getElementById('tinhTrangTuanThu').value = 'Tuân thủ';
        toggleRemedy();
    }

    function exportToExcel() {
        if(dataStore.length === 0) {
            alert("Chưa có dữ liệu để xuất!");
            return;
        }
        const worksheet = XLSX.utils.json_to_sheet(dataStore);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Thống Kê");
        XLSX.writeFile(workbook, "Bao_Cao_Tuan_Thu_Thiet_Bi.xlsx");
    }
</script>

</body>
</html>
