<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ Thống Đào Tạo & Kiểm Tra HSE</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --primary: #1a73e8; --success: #28a745; --test: #e67e22; --bg: #f8f9fa; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 500px; margin-bottom: 20px; }
        h2 { color: var(--primary); text-align: center; margin-bottom: 20px; border-bottom: 2px solid var(--bg); padding-bottom: 10px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 13px; color: #444; }
        input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 14px; }
        .btn-generate { background: var(--primary); color: white; border: none; width: 100%; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-confirm { background: var(--success); color: white; border: none; width: 100%; padding: 15px; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 10px; }
        .btn-test { background: var(--test); color: white; text-decoration: none; display: none; text-align: center; padding: 15px; border-radius: 6px; font-weight: bold; margin-top: 15px; transition: 0.3s; }
        #qrcode { margin-top: 20px; display: flex; flex-direction: column; align-items: center; padding: 15px; border: 1px dashed #ccc; border-radius: 8px; }
        .hidden { display: none; }
        .info-card { background: #e8f0fe; border-left: 5px solid var(--primary); padding: 15px; border-radius: 4px; }
        .success-msg { color: var(--success); font-weight: bold; text-align: center; margin-top: 10px; display: none; }
    </style>
</head>
<body>

<div id="admin-section" class="container">
    <h2>Thiết Lập Lớp Học & QR</h2>
    <div class="form-group">
        <label>Mã lớp (Tự động):</label>
        <input type="text" id="inputMaLop" readonly>
    </div>
    <div class="form-group">
        <label>Tên lớp đào tạo:</label>
        <input type="text" id="inputTenLop" placeholder="VD: An toàn vệ sinh lao động">
    </div>
    <div class="form-group">
        <label>Link bài kiểm tra (Google Form...):</label>
        <input type="url" id="inputLinkTest" placeholder="https://forms.gle/...">
    </div>
    <div style="display: flex; gap: 10px;">
        <div class="form-group" style="flex:1">
            <label>Bắt đầu:</label>
            <input type="time" id="timeStart">
        </div>
        <div class="form-group" style="flex:1">
            <label>Kết thúc:</label>
            <input type="time" id="timeEnd">
        </div>
    </div>
    <button class="btn-generate" onclick="generateQR()">TẠO MÃ QR TỔNG HỢP</button>
    
    <div id="qrcode" class="hidden">
        <div id="qr-canvas"></div>
        <p id="qrMaHienThi" style="margin-top:10px; font-weight:bold; color:var(--primary)"></p>
    </div>
</div>

<div id="checkin-section" class="container hidden">
    <h2>Thông Tin Lớp Học</h2>
    <div class="info-card">
        <p><strong>Lớp:</strong> <span id="dispTen"></span></p>
        <p><strong>Mã:</strong> <span id="dispMa"></span></p>
        <p><strong>Giờ học:</strong> <span id="dispTime"></span></p>
    </div>

    <div style="margin-top: 20px;">
        <label>Mã Số Nhân Viên (MSNV):</label>
        <input type="text" id="msnv" placeholder="Nhập MSNV..." oninput="lookupEmployee()">
        <label style="margin-top:10px;">Họ tên:</label>
        <input type="text" id="fullname" readonly style="background:#f1f3f4">
    </div>

    <button id="btnConfirm" class="btn-confirm" onclick="confirmAttendance()">XÁC NHẬN ĐIỂM DANH</button>
    
    <div id="successMsg" class="success-msg">✓ Đã điểm danh thành công!</div>
    
    <a id="linkTest" href="#" target="_blank" class="btn-test">LÀM BÀI KIỂM TRA THU HOẠCH</a>
</div>

<script>
    // Tự động tạo mã lớp duy nhất
    window.onload = function() {
        const timestamp = Date.now().toString().slice(-6);
        document.getElementById("inputMaLop").value = "HSE-" + timestamp;
        
        const params = new URLSearchParams(window.location.search);
        if (params.has('ma')) {
            document.getElementById("admin-section").classList.add("hidden");
            document.getElementById("checkin-section").classList.remove("hidden");
            document.getElementById("dispMa").innerText = params.get('ma');
            document.getElementById("dispTen").innerText = params.get('ten');
            document.getElementById("dispTime").innerText = params.get('start') + " - " + params.get('end');
            // Gán link test vào nút nhưng chưa cho hiện
            document.getElementById("linkTest").href = params.get('link') || "#";
        }
    };

    let qr = new QRCode(document.getElementById("qr-canvas"), { width: 180, height: 180 });

    function generateQR() {
        const ma = document.getElementById("inputMaLop").value;
        const ten = document.getElementById("inputTenLop").value;
        const link = document.getElementById("inputLinkTest").value;
        const start = document.getElementById("timeStart").value;
        const end = document.getElementById("timeEnd").value;

        if (!ten || !start || !end) return alert("Vui lòng nhập tên lớp và thời gian!");

        // Đóng gói link test vào QR
        const dataString = `ma=${ma}&ten=${encodeURIComponent(ten)}&start=${start}&end=${end}&link=${encodeURIComponent(link)}`;
        const currentUrl = window.location.href.split('?')[0];
        
        qr.clear();
        qr.makeCode(currentUrl + "?" + dataString);
        document.getElementById("qrcode").classList.remove("hidden");
        document.getElementById("qrMaHienThi").innerText = "LỚP: " + ma;
    }

    const employees = { "NV001": "Nguyễn Vinh Lam", "NV002": "Chí Tắc Phúc", "NV003": "Trần Anh Tuấn" };

    function lookupEmployee() {
        const id = document.getElementById("msnv").value.toUpperCase();
        document.getElementById("fullname").value = employees[id] || "";
    }

    function confirmAttendance() {
        const name = document.getElementById("fullname").value;
        if (!name) return alert("MSNV không hợp lệ!");

        // 1. Hiện thông báo thành công
        document.getElementById("successMsg").style.display = "block";
        document.getElementById("btnConfirm").style.display = "none";

        // 2. Hiện nút làm bài kiểm tra (nếu có link)
        const testBtn = document.getElementById("linkTest");
        if (testBtn.href.includes("http")) {
            testBtn.style.display = "block";
        } else {
            alert("Điểm danh thành công! (Lớp này không có bài kiểm tra)");
        }
    }
</script>
</body>
</html>
